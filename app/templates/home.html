<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ROBOVISION: Comparing image recognition APIs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cutestrap/1.3.1/css/cutestrap.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous"> -->
    <link href="https://fonts.googleapis.com/css?family=Luckiest+Guy" rel="stylesheet">
    <script src="/static/js/dropzone.js"></script>
</head>

<body>
  <div class="wrapper">
    <h1 id="title" class="ta-center">ROBOVISION!</h1>
    <p class="ta-center">Click my eye or drag an image onto it and I will tell you what I think I see!</p>
    <div class="grid">
      <div id="left_side">
        <div id="theRobot" class="ta-center">
          <img src="/static/img/robot.svg" alt="I am a robot!">
          <div id="spinner"></div>
          <form action="" id="eye-form" class="dropzone">
            <div class="dz-message"></div>
          </form>
        </div>
      </div>
      <div id="right_side">
        <div id="previews" class="dropzone-previews"></div>
        <div id="results">
        </div>
      </div>

    </div>
  </div>
  <audio id="ding" src="/static/audio/ding.mp3" hidden preload="auto"></audio>
  <audio id="beepboop" src="/static/audio/beepboop.mp3" hidden preload="auto"></audio>
  <footer class="ta-center fs-small">
    <a href='http://www.freepik.com/free-vector/cute-robots-collection_713858.htm'>Robot Designed by Freepik</a>
    <a href="https://www.freesound.org/people/monsterjazzlicks/sounds/347513/">"Five Little Fingers" by monsterjazzlicks</a>
  </footer>
  <div id="preview-template" style="display: none;">
    <div class="dz-preview dz-file-preview">
      <img class="thumbnail" data-dz-thumbnail />
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>

  <script>
      var files = [];
      var file;
      var pendingResults = 0;
      const beepboop = document.querySelector('#beepboop');
      const ding = document.querySelector('#ding');
      const service_names = ["GoogleVision", "CloudSight", "Rekognition"]
      const services_count = service_names.length;
      Dropzone.autoDiscover = false;
      $(function() {
        var myDropzone = new Dropzone("#eye-form", {
          url: function(files){
            return("");
          },
          accept: function(file) {
            $("#results").text("");
            sendTheFile(file);
          },
          thumbnail(imageFile, dataURL){ // we have to catch it here to be able to clear #previews before new images come in, but because of that, we're having to add the thumbnails manually
            if (pendingResults === 0) {
              $("#previews").html(""); // checking to see if this is a new batch of images, if so, clear our #previews first
            }
            $("#previews").append(`<div class="dz-preview dz-image-preview" data-filename="${imageFile.name}"><img src=${dataURL} alt="${imageFile.name}"></div>`)
            pendingResults += services_count;
          },
          previewTemplate: document.getElementById('preview-template').innerHTML,
          previewsContainer: "#previews",
          acceptedFiles: "image/*"
        });
      })

      function sendTheFile(file) {
          var formData = new FormData();
          formData.append("image", file);
          $("#spinner").show();
          beepboop.play();
          service_names.forEach(function(name) {
            $.ajax({
                url: `/api/1/${name}`,
                data: formData,
                processData: false,
                contentType: false,
                type: "POST",
                success: function(result) {
                  if (result.length === 0) {
                    $(`#previews [data-filename='${file.name}']`).append(`<p class="fw-bold fs-large">${name} couldn't recognize this</h4>`);
                  } else {
                    $(`#previews [data-filename='${file.name}']`).append(`<p class="fw-bold fs-large">${name} sees: ${result}</h4>`);
                  }
                },
                error: function(jqXHR, status, errorText) {
                  $(`#previews [data-filename='${file.name}']`).append(`<p class="error fw-bold fs-large">Oops, ${name} had an error! <span class="errortext">${errorText}</span> (It's not your fault, I promise)</p>`);
                },
                complete: function(jqXHR, status) {
                  resultsBack();
                }
            });
          })
      }
      function resultsBack(jqXHR, status) {
        pendingResults -= 1;
        if(pendingResults ===0){
          $("#spinner").hide();
          beepboop.pause();
          ding.play();
        }
      }
  </script>
</body>

</html>
